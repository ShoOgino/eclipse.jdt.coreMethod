void formatSource(String source, String formattedOutput) {
	int regionStart = source.indexOf("[#");
	if (regionStart != -1) {
		IRegion[] regions =  new Region[10];
		int idx = 0;
		int start = 0;
		int delta = 0;
		StringBuffer buffer = new StringBuffer();
		while (regionStart != -1) {
			buffer.append(source.substring(start, regionStart));
			int regionEnd = source.indexOf("#]", regionStart+2);
			buffer.append(source.substring(regionStart+2, regionEnd));
			regions[idx++] = new Region(regionStart-delta, regionEnd-(regionStart+2));
			delta += 4;
			start = regionEnd + 2;
			regionStart = source.indexOf("[#", start);
		}
		System.arraycopy(regions, 0, regions = new Region[idx], 0, idx);
		buffer.append(source.substring(start, source.length()));
		String newSource = buffer.toString();
		String result = runFormatter(codeFormatter(), newSource, CodeFormatter.K_COMPILATION_UNIT | CodeFormatter.F_INCLUDE_COMMENTS, 0, regions, Util.LINE_SEPARATOR);
		assertLineEquals(result, newSource, formattedOutput, false);
	} else {
		formatSource(source, formattedOutput, CodeFormatter.K_COMPILATION_UNIT | CodeFormatter.F_INCLUDE_COMMENTS, 0, false, 0, -1, null);
	}
}

