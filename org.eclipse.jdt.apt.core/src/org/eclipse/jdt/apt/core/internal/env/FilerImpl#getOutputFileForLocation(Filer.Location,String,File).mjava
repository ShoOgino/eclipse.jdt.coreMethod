    private File getOutputFileForLocation( Filer.Location loc, String pkg, File relPath )
    	throws IOException
    {
    	GeneratedFileManager gfm = GeneratedFileManager.getGeneratedFileManager( _env.getProject() );
    	File f = null;
    	if ( loc == Filer.Location.CLASS_TREE )
    	{
    		try 
    		{
    			f = gfm.getGeneratedSourceFolderOutputLocation();
    		}
    		catch ( Exception e )
    		{
    			// TODO - stop throwing this exception
    			AptPlugin.log(e, "Failure getting the output file"); //$NON-NLS-1$
    			throw new IOException();
    		}
    	}
    	else if ( loc == Filer.Location.SOURCE_TREE )
    		f = gfm.getGeneratedSourceFolder().getRawLocation().toFile();
    	
        if( pkg != null )
            f = new File( f, pkg.replace('.', File.separatorChar) );

        f = new File( f, relPath.getPath() );
    	
        // REVIEW: for no apparent reason it is sometimes necessary to create the
        // parent dir, else an IOException occurs creating f..
        File p = f.getParentFile();
        FileSystemUtil.mkdirs( p );
        
    	return f;
    }

