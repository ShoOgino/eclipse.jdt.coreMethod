    public void close()
    {
        try
        {
            String contents = _sw.toString();
            super.close();
            GeneratedFileManager gfm = GeneratedFileManager.getGeneratedFileManager();
            ProcessorEnvImpl.Phase phase = _env.getPhase();
		
            if ( phase == ProcessorEnvImpl.Phase.RECONCILE )
            {
            	ICompilationUnit parentCompilationUnit = _env.getCompilationUnit();
                ICompilationUnit cu  = gfm.generateFileDuringReconcile( 
                    parentCompilationUnit, _typeName, contents, DefaultWorkingCopyOwner.PRIMARY, null, null );
				_env.addGeneratedFile( (IFile)cu.getResource() );
            }
            else if ( phase == ProcessorEnvImpl.Phase.BUILD)	
            {
				IFile f = gfm.generateFileDuringBuild( _env.getFile(), _env.getProject(), _typeName, contents, null /* progress monitor */, _charsetName );
				_env.addGeneratedFile( f );
            }
            else
            {
                assert false : "Unexpected phase value: " + phase ;
            }
        }
        catch ( JavaModelException jme )
        {
            // TODO:  handle this exception in a nicer way.
            jme.printStackTrace();
            throw new RuntimeException( jme );
        }
        catch ( CoreException ce )
        {
            // TODO:  handle this exception
            ce.printStackTrace();
            throw new RuntimeException( ce );
        }
        catch( UnsupportedEncodingException use )
        {
        	// TODO: handle this exception
        	throw new RuntimeException( use );
        }
    }

