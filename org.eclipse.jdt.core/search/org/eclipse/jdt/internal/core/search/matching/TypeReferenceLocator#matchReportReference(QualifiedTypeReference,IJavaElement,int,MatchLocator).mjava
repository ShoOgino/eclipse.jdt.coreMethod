protected void matchReportReference(QualifiedTypeReference qTypeRef, IJavaElement element, int accuracy, MatchLocator locator) throws CoreException {
	TypeBinding typeBinding = qTypeRef.resolvedType;
	int lastIndex = qTypeRef.tokens.length - 1;
	if (typeBinding instanceof ArrayBinding)
		typeBinding = ((ArrayBinding) typeBinding).leafComponentType;
	if (typeBinding instanceof ProblemReferenceBinding) {
		ProblemReferenceBinding pbBinding = (ProblemReferenceBinding) typeBinding;
		typeBinding = pbBinding.original;
		lastIndex = pbBinding.compoundName.length - 1;
	}
	// try to match all enclosing types for which the token matches as well
	if (typeBinding instanceof ReferenceBinding) {
		ReferenceBinding refBinding = (ReferenceBinding) typeBinding; 
		while (refBinding != null && lastIndex >= 0) {
			if (resolveLevelForType(refBinding) != IMPOSSIBLE_MATCH) {
				if (locator.encloses(element)) {
					long[] positions = qTypeRef.sourcePositions;
					// index now depends on pattern type signature
					int index = lastIndex;
					if (this.pattern.qualification != null) {
						if (this.pattern.typeSignatures != null) {
							if (this.pattern.typeSignatures.length > 1) {
								index = lastIndex - (this.pattern.typeSignatures.length - 1);
							}
						} else {
							index = lastIndex - this.pattern.segmentsSize;
						}
					}
					if (index < 0) index = 0;
					int start = (int) ((positions[index]) >>> 32);
					int end = (int) positions[lastIndex];
					int refinedAccuracy = accuracy;
					if (this.pattern != null && this.pattern.isParameterized() && refBinding.isParameterizedType()) {
						ParameterizedTypeBinding parameterizedBinding = (ParameterizedTypeBinding)refBinding;
						refinedAccuracy = refineAccuracy(accuracy, parameterizedBinding, this.pattern.typeArguments, locator);
						if (refinedAccuracy == -1) return; // refined accuracy shows an impossible match...
						// specific report accurate match for parameterized types
						TypeReference[] typeArguments = qTypeRef instanceof ParameterizedQualifiedTypeReference ? ((ParameterizedQualifiedTypeReference) qTypeRef).typeArguments[lastIndex] : null;
						locator.reportAccurateParameterizedTypeReference(qTypeRef, this.pattern.simpleName, start, typeArguments, element, refinedAccuracy);
						return;
					}
					SearchMatch match = locator.newTypeReferenceMatch(element, refinedAccuracy, start, end-start+1, qTypeRef);
					locator.report(match);
				}
				return;
			}
			lastIndex--;
			refBinding = refBinding.enclosingType();
		}
	}
	locator.reportAccurateTypeReference(qTypeRef, this.pattern.simpleName, element, accuracy);
}

