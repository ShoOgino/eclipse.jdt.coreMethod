	/** 
	 * Reads and reconstructs a state from the given input stream.
	 */
	public StateImpl read(
		JavaDevelopmentContextImpl dc,
		IProject project,
		DataInputStream in)
		throws IOException {

		/* magic number and version have already been read */
		StateImpl state = new StateImpl(dc, project);
		int fingerprintLen = in.readShort();
		byte[] fingerprint = new byte[fingerprintLen];
		in.readFully(fingerprint);
		state.setFingerprint(fingerprint);

		// Read pool.
		StateSnapConstantPool pool = new StateSnapConstantPool(dc, in, this);
		state.readClassPath(); // Read classpath from the project
		state.setBuildContext(readBuildContext(dc, pool, in));
		PackageMap packageMap = readPackageMap(pool, in);
		state.setPackageMap(packageMap);
		state.setSourceElementTable(readSourceElementTable(pool, in));
		state.setPrincipalStructureTable(readPrincipalStructureTable(pool, in, state));
		state.setProblemReporter(readProblemReporter(project, pool, in));
		state.setInternalDependencyGraph(readDependencyGraph(pool, in, state));
		state.buildPrincipalStructureByPackageTable();

		// We don't need the project any more
		//state.resetProject();
		return state;
	}

