/**
 * @see org.eclipse.jdt.core.eval.IEvaluationContext#codeComplete(String, int, ICompletionRequestor, WorkingCopyOwner)
 */
public void codeComplete(String codeSnippet, int position, ICompletionRequestor requestor, WorkingCopyOwner owner) throws JavaModelException {
	NameLookup lookup = null;
	try {
		// set the units to look inside
		lookup = this.project.getNameLookup();
		JavaModelManager manager = JavaModelManager.getJavaModelManager();
		ICompilationUnit[] workingCopies = manager.getWorkingCopies(owner, true/*add primary WCs*/);
		lookup.setUnitsToLookInside(workingCopies);

		// code complete
		this.context.complete(
			codeSnippet.toCharArray(),
			position,
			this.project.getSearchableNameEnvironment(),
			new CompletionRequestorWrapper(requestor, lookup),
			this.project.getOptions(true),
			this.project
		);
	} finally {
		if (lookup != null) {
			lookup.setUnitsToLookInside(null);
		}
	}
}

