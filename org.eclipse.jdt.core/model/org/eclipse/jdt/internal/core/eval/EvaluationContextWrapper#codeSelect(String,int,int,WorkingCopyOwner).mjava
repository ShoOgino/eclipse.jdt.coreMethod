/**
 * @see org.eclipse.jdt.core.eval.IEvaluationContext#codeSelect(String, int, int, WorkingCopyOwner)
 */
public IJavaElement[] codeSelect(String codeSnippet, int offset, int length, WorkingCopyOwner owner) throws JavaModelException {
	NameLookup lookup = null;
	try {
		// set the units to look inside
		lookup = this.project.getNameLookup();
		JavaModelManager manager = JavaModelManager.getJavaModelManager();
		ICompilationUnit[] workingCopies = manager.getWorkingCopies(owner, true/*add primary WCs*/);
		lookup.setUnitsToLookInside(workingCopies);

		// code select
		SelectionRequestor requestor= new SelectionRequestor(lookup, null); // null because there is no need to look inside the code snippet itself
		this.context.select(
			codeSnippet.toCharArray(),
			offset,
			offset + length - 1,
			this.project.getSearchableNameEnvironment(),
			requestor,
			this.project.getOptions(true)
		);
		return requestor.getElements();
	} finally {
		if (lookup != null) {
			lookup.setUnitsToLookInside(null);
		}
	}
}

