/**
 * @see Openable
 */
protected IBuffer openBuffer(IProgressMonitor pm) throws JavaModelException {

	if (this.useCount == 0) throw newNotPresentException(); // was destroyed
	
	// create buffer - working copies may use custom buffer factory
	IBuffer buffer = getBufferFactory().createBuffer(this);
	if (buffer == null) return null;

	// set the buffer source if needed
	if (buffer.getCharacters() == null){
		ICompilationUnit original= (ICompilationUnit)this.getOriginalElement();
		IBuffer originalBuffer = null;
		try {
			originalBuffer = original.getBuffer();
		} catch (JavaModelException e) {
			// original element does not exist: create an empty working copy
			if (!e.getJavaModelStatus().isDoesNotExist()) {
				throw e;
			}
		}
		if (originalBuffer != null) {
			char[] originalContents = originalBuffer.getCharacters();
			if (originalContents != null) {
				buffer.setContents((char[])originalContents.clone());
			}
		} else {
			// initialize buffer
			buffer.setContents(CharOperation.NO_CHAR);
		}
	}

	// add buffer to buffer cache
	this.getBufferManager().addBuffer(buffer);

	// listen to buffer changes
	buffer.addBufferChangedListener(this);

	return buffer;	
}

