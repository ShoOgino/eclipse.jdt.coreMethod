	public Hashtable getOptions() {

		// return cached options if already computed
		Hashtable cachedOptions; // use a local variable to avoid race condition (see https://bugs.eclipse.org/bugs/show_bug.cgi?id=256329 )
		if ((cachedOptions = this.optionsCache) != null) {
			if (DEBUG_302850) checkTaskTags("Retrieving options from optionsCache", this.optionsCache); //$NON-NLS-1$
			return new Hashtable(cachedOptions);
		}
		if (DEBUG_302850) System.out.println("optionsCache was null"); //$NON-NLS-1$
		if (!Platform.isRunning()) {
			this.optionsCache = getDefaultOptionsNoInitialization();
			if (DEBUG_302850) checkTaskTags("Platform is not running", this.optionsCache); //$NON-NLS-1$
			return new Hashtable(this.optionsCache);
		}
		// init
		Hashtable options = new Hashtable(10);
		IPreferencesService service = Platform.getPreferencesService();

		// set options using preferences service lookup
		Iterator iterator = this.optionNames.iterator();
		while (iterator.hasNext()) {
			String propertyName = (String) iterator.next();
			String propertyValue = service.get(propertyName, null, this.preferencesLookup);
			if (propertyValue != null) {
				options.put(propertyName, propertyValue);
			}
		}
		if (DEBUG_302850) checkTaskTags("Options initialized from preferences", options); //$NON-NLS-1$

		// get encoding through resource plugin
		options.put(JavaCore.CORE_ENCODING, JavaCore.getEncoding());

		// backward compatibility
		addDeprecatedOptions(options);
		try {
			final IEclipsePreferences eclipsePreferences = this.preferencesLookup[PREF_INSTANCE];
			String[] instanceKeys = eclipsePreferences.keys();
			for (int i=0, length=instanceKeys.length; i<length; i++) {
				String optionName = instanceKeys[i];
				migrateObsoleteOption(options, optionName, eclipsePreferences.get(optionName, null));
			}
		} catch (BackingStoreException e) {
			// skip
		}

		Util.fixTaskTags(options);
		if (DEBUG_302850) checkTaskTags("Retrieved options from preferences", options); //$NON-NLS-1$
		// store built map in cache
		this.optionsCache = new Hashtable(options);
		if (DEBUG_302850) checkTaskTags("Stored optionsCache", this.optionsCache); //$NON-NLS-1$

		// return built map
		return options;
	}

