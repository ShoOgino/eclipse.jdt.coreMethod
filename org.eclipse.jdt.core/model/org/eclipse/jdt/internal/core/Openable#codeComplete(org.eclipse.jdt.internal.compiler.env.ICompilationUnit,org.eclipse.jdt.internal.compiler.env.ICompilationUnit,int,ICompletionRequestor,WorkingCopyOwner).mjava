protected void codeComplete(org.eclipse.jdt.internal.compiler.env.ICompilationUnit cu, org.eclipse.jdt.internal.compiler.env.ICompilationUnit unitToSkip, int position, ICompletionRequestor requestor, WorkingCopyOwner owner) throws JavaModelException {
	if (requestor == null) {
		throw new IllegalArgumentException("Completion requestor cannot be null"); //$NON-NLS-1$
	}
	IBuffer buffer = getBuffer();
	if (buffer == null) {
		return;
	}
	if (position < -1 || position > buffer.getLength()) {
		throw new IllegalArgumentException("Completion position "+position+" is not located in supplied source range (0, "+buffer.getLength()+")"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
	}
	JavaProject project = (JavaProject) getJavaProject();
	SearchableEnvironment environment = null;
	NameLookup nameLookup = null;
	try {
		// set unit to skip
		environment = (SearchableEnvironment) project.getSearchableNameEnvironment();
		environment.unitToSkip = unitToSkip;
	
		// set the units to look inside
		nameLookup = project.getNameLookup();
		JavaModelManager manager = JavaModelManager.getJavaModelManager();
		ICompilationUnit[] workingCopies = manager.getWorkingCopies(owner, true/*add primary WCs*/);
		nameLookup.setUnitsToLookInside(workingCopies);

		// code complete
		CompletionRequestorWrapper requestorWrapper = new CompletionRequestorWrapper(requestor,nameLookup);
		CompletionEngine engine = new CompletionEngine(environment, requestorWrapper, project.getOptions(true), project);
		requestorWrapper.completionEngine = engine;
		engine.complete(cu, position, 0);
	} finally {
		if (environment != null) {
			environment.unitToSkip = null;
		}
		if (nameLookup != null) {
			nameLookup.setUnitsToLookInside(null);
		}
	}
}

