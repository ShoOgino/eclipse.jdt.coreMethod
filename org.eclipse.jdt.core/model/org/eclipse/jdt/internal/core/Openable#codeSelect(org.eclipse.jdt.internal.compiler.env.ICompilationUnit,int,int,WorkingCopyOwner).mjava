protected IJavaElement[] codeSelect(org.eclipse.jdt.internal.compiler.env.ICompilationUnit cu, int offset, int length, WorkingCopyOwner owner) throws JavaModelException {
	NameLookup nameLookup = null;
	try {
		// set the units to look inside
		nameLookup = ((JavaProject)getJavaProject()).getNameLookup();
		JavaModelManager manager = JavaModelManager.getJavaModelManager();
		ICompilationUnit[] workingCopies = manager.getWorkingCopies(owner, true/*add primary WCs*/);
		nameLookup.setUnitsToLookInside(workingCopies);

		// code select
		SelectionRequestor requestor= new SelectionRequestor(nameLookup, this);
		IBuffer buffer = getBuffer();
		if (buffer == null) {
			return requestor.getElements();
		}
		int end= buffer.getLength();
		if (offset < 0 || length < 0 || offset + length > end ) {
			throw new IllegalArgumentException("Selected range ("+offset+ ", " + (offset+length)+") is not located in supplied source range (0, "+end+")"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$ //$NON-NLS-4$
		}
	
		// fix for 1FVGGKF
		JavaProject project = (JavaProject)getJavaProject();
		ISearchableNameEnvironment environment = project.getSearchableNameEnvironment();
		
		// fix for 1FVXGDK
		SelectionEngine engine = new SelectionEngine(environment, requestor, project.getOptions(true));
		engine.select(cu, offset, offset + length - 1);
		return requestor.getElements();
	} finally {
		if (nameLookup != null) {
			nameLookup.setUnitsToLookInside(null);
		}
	}
}

