/**
 * @see org.eclipse.jdt.internal.eval.Evaluator
 */
protected char[] getSource() {
	StringBuffer buffer = new StringBuffer();
	int lineNumberOffset = 1;
	
	// package declaration
	char[] packageName = getPackageName();
	if (packageName.length != 0) {
		buffer.append("package "/*nonNLS*/);
		buffer.append(packageName);
		buffer.append(';').append(JavaModelManager.LINE_SEPARATOR);
		lineNumberOffset++;
	}

	// import declarations
	char[][] imports = this.context.imports;
	for (int i = 0; i < imports.length; i++) {
		buffer.append("import "/*nonNLS*/);
		buffer.append(imports[i]);
		buffer.append(';').append(JavaModelManager.LINE_SEPARATOR);
		lineNumberOffset++;
	}

	// class declaration
	buffer.append("public class "/*nonNLS*/);
	buffer.append(getClassName());
	buffer.append(" extends "/*nonNLS*/);
	buffer.append(PACKAGE_NAME);
	buffer.append("."/*nonNLS*/);
	buffer.append(ROOT_CLASS_NAME);
	buffer.append(" {"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
	lineNumberOffset++;
	startPosOffset = buffer.length();

	// field declarations
	GlobalVariable[] vars = this.context.variables;
	VariablesInfo installedVars = this.context.installedVars;
	for (int i = 0; i < this.context.variableCount; i++){
		GlobalVariable var = vars[i];
		buffer.append("\tpublic static "/*nonNLS*/);
		var.declarationStart = buffer.length();
		buffer.append(var.typeName);
		buffer.append(" "/*nonNLS*/);
		char[] varName = var.name;
		buffer.append(varName);
		buffer.append(';').append(JavaModelManager.LINE_SEPARATOR);
		lineNumberOffset++;
	}

	// field initializations
	buffer.append("\tstatic {"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
	lineNumberOffset++;
	for (int i = 0; i < this.context.variableCount; i++){
		GlobalVariable var = vars[i];
		char[] varName = var.name;
		GlobalVariable installedVar = installedVars == null ? null : installedVars.varNamed(varName);
		if (installedVar == null || !CharOperation.equals(installedVar.typeName, var.typeName)) {
			// Initialize with initializer if there was no previous value
			char[] initializer = var.initializer;
			if (initializer != null) {
				buffer.append("\t\ttry {"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
				lineNumberOffset++;
				var.initializerLineStart = lineNumberOffset;
				buffer.append("\t\t\t"/*nonNLS*/);
				var.initializerStart = buffer.length();
				buffer.append(varName);
				buffer.append("= "/*nonNLS*/);
				var.initExpressionStart = buffer.length();
				buffer.append(initializer);
				lineNumberOffset += numberOfCRs(initializer);
				buffer.append(';').append(JavaModelManager.LINE_SEPARATOR);
				buffer.append("\t\t} catch (Throwable e) {"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
				buffer.append("\t\t\te.printStackTrace();"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
				buffer.append("\t\t}"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
				lineNumberOffset += 4; // 4 CRs
			}
		} else {
			// Initialize with previous value if name and type are the same
			buffer.append("\t\t"/*nonNLS*/);
			buffer.append(varName);
			buffer.append("= "/*nonNLS*/);
			char[] installedPackageName = installedVars.packageName;
			if (installedPackageName != null && installedPackageName.length != 0) {
				buffer.append(installedPackageName);
				buffer.append("."/*nonNLS*/);
			}
			buffer.append(installedVars.className);
			buffer.append("."/*nonNLS*/);
			buffer.append(varName);
			buffer.append(';').append(JavaModelManager.LINE_SEPARATOR);
			lineNumberOffset++;
		}
	}
	buffer.append("\t}"/*nonNLS*/).append(JavaModelManager.LINE_SEPARATOR);
	
	// end of class declaration
	buffer.append('}').append(JavaModelManager.LINE_SEPARATOR);

	// return result
	int length = buffer.length();
	char[] result = new char[length];
	buffer.getChars(0, length, result, 0);
	return result;
}

