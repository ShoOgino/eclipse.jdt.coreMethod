public FieldBinding[] fields() {
	
	try {
		int failed = 0;
		for (int f = 0, max = fields.length; f < max; f++) {
			if (resolveTypeFor(fields[f]) == null) {
				fields[f] = null;
				failed++;
			}
		}
		if (failed > 0) {
			int newSize = fields.length - failed;
			if (newSize == 0)
				return fields = NoFields;
	
			FieldBinding[] newFields = new FieldBinding[newSize];
			for (int i = 0, n = 0, max = fields.length; i < max; i++)
				if (fields[i] != null)
					newFields[n++] = fields[i];
			fields = newFields;
		}
	} catch(AbortCompilation e){
		// ensure null fields are removed
		FieldBinding[] newFields = null;
		int count = 0;
		for (int i = 0, max = fields.length; i < max; i++){
			FieldBinding field = fields[i];
			if (field == null && newFields == null){
				System.arraycopy(fields, 0, newFields = new FieldBinding[max], 0, i);
			} else if (newFields != null && field != null) {
				newFields[count++] = field;
			}
		}
		if (newFields != null){
			System.arraycopy(newFields, 0, fields = new FieldBinding[count], 0, count);
		}			
		throw e;
	}
	return fields;
}

