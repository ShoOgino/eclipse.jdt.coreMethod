/*
 * Compiler crash recovery in case of unexpected runtime exceptions
 */
protected void handleInternalException(Throwable internalException, CompilationUnitDeclaration unit, CompilationResult result) {

	/* dump a stack trace to the console */
	internalException.printStackTrace(); 
		
	/* find a compilation result */
	if ((unit != null)) // basing result upon the current unit if available
		result = unit.compilationResult; // current unit being processed ?
	if ((result == null) && (unitsToProcess != null) && (totalUnits > 0))
		result = unitsToProcess[totalUnits - 1].compilationResult; // last unit in beginToCompile ?
		
	if (result != null) {
		/* create and record a compilation problem */
		StringWriter stringWriter = new StringWriter();
		PrintWriter writer = new PrintWriter(stringWriter);
		internalException.printStackTrace(writer);
		StringBuffer buffer = stringWriter.getBuffer();

		result.record(
			problemReporter.createProblem(
				result.getFileName(), 
				ProblemIrritants.UnclassifiedProblem, 
				new String[] {"Internal compiler error\n" + buffer.toString()},
				Error, // severity
				0, // source start
				0, // source end
				0)); // line number		

		/* hand back the compilation result */
		if (!result.hasBeenAccepted) {
			requestor.acceptResult(result.tagAsAccepted());
		}
	}
}

